@page "/"
@using System.Text.RegularExpressions

<h1 class="text-xl font-bold mb-4">AGV 거리 비교기</h1>

<InputTextArea @bind-Value="logInput" class="w-full h-64 p-2 border rounded mb-4" placeholder="여기에 로그 데이터를 붙여넣기 하세요" />
<Button class="mb-4" @onclick="ParseLogs">분석하기</Button>

@if (results.Count > 0)
{
    <table class="result-table">
        <thead>
            <tr class="bg-gray-200">
                <th class="p-2">Task ID</th>
                <th class="p-2">Old AGV</th>
                <th class="p-2">New AGV</th>
                <th class="p-2">Closer</th>
                <th class="p-2">Old Dist</th>
                <th class="p-2">New Dist</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var r in results)
            {
                <tr>
                    <td class="border p-2">@r.TaskId</td>
                    <td class="border p-2">@r.OldAgv</td>
                    <td class="border p-2">@r.NewAgv</td>
                    <td class="border p-2 font-bold">@r.CloserAgv</td>
                    <td class="border p-2">@r.OldDistance</td>
                    <td class="border p-2">@r.NewDistance</td>
                </tr>
            }
        </tbody>
    </table>
}
<style>
    .result-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .result-table th,
    .result-table td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: center;
    }

    .result-table th {
        background-color: #f0f0f0;
    }
</style>
@code {
    private string logInput = string.Empty;

    private class AGVResult
    {
        public string TaskId { get; set; } = "";
        public string OldAgv { get; set; } = "";
        public string NewAgv { get; set; } = "";
        public double OldDistance { get; set; }
        public double NewDistance { get; set; }
        public string CloserAgv => OldDistance < NewDistance ? OldAgv : NewAgv;
    }

    private List<AGVResult> results = new();

    private void ParseLogs()
    {
        results.Clear();
        var regex = new Regex(@"taskid:(.*?), old_agv:(\d+), new_agv:(\d+),.*?task_position:\((\d+),(\d+)\), old_agv_position:\((\d+),(\d+)\), new_agv_position:\((\d+),(\d+)\)");

        foreach (Match match in regex.Matches(logInput))
        {
            string taskId = match.Groups[1].Value;
            string oldAgv = match.Groups[2].Value;
            string newAgv = match.Groups[3].Value;
            int tx = int.Parse(match.Groups[4].Value);
            int ty = int.Parse(match.Groups[5].Value);
            int ox = int.Parse(match.Groups[6].Value);
            int oy = int.Parse(match.Groups[7].Value);
            int nx = int.Parse(match.Groups[8].Value);
            int ny = int.Parse(match.Groups[9].Value);

            double oldDist = Math.Sqrt(Math.Pow(ox - tx, 2) + Math.Pow(oy - ty, 2));
            double newDist = Math.Sqrt(Math.Pow(nx - tx, 2) + Math.Pow(ny - ty, 2));

            results.Add(new AGVResult
            {
                TaskId = taskId,
                OldAgv = oldAgv,
                NewAgv = newAgv,
                OldDistance = Math.Round(oldDist, 2),
                NewDistance = Math.Round(newDist, 2)
            });
        }
    }
}
